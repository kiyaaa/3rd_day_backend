<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarah Lee - 연결이</title>
    <link rel="stylesheet" href="shared-styles.css">
</head>
<body>
    <div class="header">
        <div class="user-avatar" style="background:#e91e63">SL</div>
        <div class="user-info">
            <h2>Sarah Lee (React 전문가)</h2>
            <div class="status">온라인</div>
        </div>
    </div>

    <div class="chat-container">
        <div class="connection-status disconnected" id="connectionStatus">
            연결 끊김
        </div>

        <div class="messages" id="messages"></div>
        
        <div class="typing-indicator" id="typingIndicator" style="display:none"></div>
    </div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="메시지 입력..." disabled>
        <button id="sendBtn" onclick="sendMessage()" disabled>전송</button>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const API_URL = 'http://localhost:3004/api';
        const WS_URL = 'http://localhost:3004';
        
        let socket = null;
        let token = null;
        let currentRoom = null;
        let questionId = null;
        let userId = null;

        // 데모 모드로 바로 연결
        async function login() {
            // 데모 모드 - 로그인 과정 생략
            userId = 2;
            token = 'demo-token';
            addSystemMessage('데모 모드로 시작 (React 전문가)');
            connectWebSocket();
        }

        // WebSocket 연결
        function connectWebSocket() {
            socket = io(WS_URL, {
                auth: { 
                    demo: 'true',
                    demoUser: 'sarah@demo.com'
                }
            });

            socket.on('connect', () => {
                document.getElementById('connectionStatus').textContent = '연결됨';
                document.getElementById('connectionStatus').className = 'connection-status connected';
                addSystemMessage('WebSocket 연결됨');
            });

            socket.on('disconnect', () => {
                document.getElementById('connectionStatus').textContent = '연결 끊김';
                document.getElementById('connectionStatus').className = 'connection-status disconnected';
            });

            socket.on('new_message', (msg) => {
                if (msg.sender_id !== userId) {
                    addMessage(msg.sender_name, msg.content, false, new Date(msg.created_at));
                }
            });

            socket.on('user_joined', (data) => {
                addSystemMessage(`${data.userName}님이 입장했습니다`);
            });

            socket.on('user_left', (data) => {
                addSystemMessage(`${data.userName}님이 나갔습니다`);
            });

            socket.on('typing_indicator', (data) => {
                const indicator = document.getElementById('typingIndicator');
                if (data.isTyping && data.userName !== 'Sarah Lee') {
                    indicator.textContent = `${data.userName}님이 입력 중...`;
                    indicator.style.display = 'block';
                } else {
                    indicator.style.display = 'none';
                }
            });

            socket.on('question_assigned', (data) => {
                questionId = data.questionId;
                showExpertNotification(data);
            });
            
            // 데모용 이벤트 리스너
            socket.on('notify_experts', (data) => {
                questionId = data.questionId;
                showExpertNotification(data);
            });

            socket.on('room_created', (data) => {
                addSystemMessage(`채팅방이 생성되었습니다 (ID: ${data.roomId})`);
                // 자동 입장 버튼 표시
                setTimeout(() => {
                    addSystemMessage(`
                        <button onclick="joinRoom(${data.roomId})" style="background:#25d366;color:white;border:none;padding:8px 16px;border-radius:5px;cursor:pointer">
                            채팅방 입장하기
                        </button>
                    `);
                }, 1000);
            });
            
            // 데모용 채팅방 생성 이벤트
            socket.on('create_room', (data) => {
                addSystemMessage(`채팅방이 생성되었습니다 (ID: ${data.roomId})`);
                // 자동 입장 버튼 표시
                setTimeout(() => {
                    addSystemMessage(`
                        <button onclick="joinRoom(${data.roomId})" style="background:#25d366;color:white;border:none;padding:8px 16px;border-radius:5px;cursor:pointer">
                            채팅방 입장하기
                        </button>
                    `);
                }, 1000);
            });
        }

        // 전문가 알림 표시
        function showExpertNotification(data) {
            const messagesDiv = document.getElementById('messages');
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'expert-notification';
            notificationDiv.innerHTML = `
                <h4>새로운 질문이 배정되었습니다!</h4>
                <p><strong>제목:</strong> ${data.title}</p>
                <p><strong>내용:</strong> ${data.content}</p>
                <p><strong>긴급도:</strong> ${data.urgency}</p>
                <div class="actions">
                    <button class="accept" onclick="acceptQuestion()">수락</button>
                    <button class="reject" onclick="rejectQuestion()">거절</button>
                </div>
            `;
            messagesDiv.appendChild(notificationDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // 질문 수락
        function acceptQuestion() {
            socket.emit('accept_question', { questionId });
            addSystemMessage('질문을 수락했습니다');
            document.querySelector('.expert-notification').remove();
        }

        // 질문 거절
        function rejectQuestion() {
            socket.emit('reject_question', { questionId });
            addSystemMessage('질문을 거절했습니다');
            document.querySelector('.expert-notification').remove();
            questionId = null;
        }

        // 채팅방 입장
        function joinRoom(roomId) {
            currentRoom = roomId;
            socket.emit('join_room', { roomId: roomId.toString() });
            
            // 입력 필드 활성화
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            addSystemMessage(`채팅방 ${roomId}에 입장했습니다`);
        }

        // 메시지 전송
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentRoom) return;
            
            socket.emit('send_message', {
                roomId: currentRoom.toString(),
                content: content,
                type: 'text'
            });
            
            addMessage('Sarah Lee', content, true);
            input.value = '';
        }

        // 메시지 UI 추가
        function addMessage(sender, content, isSent = false, time = new Date()) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            const timeStr = time.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            if (!isSent) {
                messageDiv.innerHTML = `
                    <div class="sender">${sender}</div>
                    <div>${content}</div>
                    <div class="time">${timeStr}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div>${content}</div>
                    <div class="time">${timeStr}</div>
                `;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // 시스템 메시지
        function addSystemMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Enter 키 처리
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // 자동 로그인
            login();
        });
    </script>
</body>
</html>